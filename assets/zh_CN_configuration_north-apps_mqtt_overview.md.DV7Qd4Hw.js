import{_ as s,c as r,o as i,ah as a,iC as n,iD as o,iE as e}from"./chunks/framework.DGOuNAW6.js";const E=JSON.parse('{"title":"MQTT","description":"","frontmatter":{},"headers":[],"relativePath":"zh_CN/configuration/north-apps/mqtt/overview.md","filePath":"zh_CN/configuration/north-apps/mqtt/overview.md"}'),l={name:"zh_CN/configuration/north-apps/mqtt/overview.md"};function d(h,t,p,g,k,T){return i(),r("div",null,[...t[0]||(t[0]=[a(`<h1 id="mqtt" tabindex="-1">MQTT <a class="header-anchor" href="#mqtt" aria-label="Permalink to “MQTT”">​</a></h1><p><a href="https://mqtt.org" target="_blank" rel="noreferrer">MQTT</a> 是一种轻量级的消息传输协议，专为物联网设备和应用程序设计。它采用发布与订阅模型，允许设备和应用程序通过中间代理（Broker）进行通信。MQTT拥有轻量级、高效率和可靠性等诸多优点，特别适用于边缘硬件资源有限，需要高效地传输实时数据，以及对通信延迟和带宽占用有要求的场景。</p><p>MQTT协议在工业互联网中得到广泛选择和应用，它为工业互联网带来了实时数据交换、设备互通性、资源节约和稳定可靠等诸多价值，成为工业互联网通信的重要基石。</p><p>GridBeat 支持 MQTT 插件作为其数据汇聚上报的方式之一，GridBeat MQTT 插件允许用户快速构建使用 MQTT 协议的物联网应用程序，可以在设备和云之间进行通讯。开发人员还可以通过 MQTT 插件向 IoT 设备发布控制指令，触发设备操作，例如打开或关闭灯、电机或者其他设备。</p><p>此外，MQTT 插件还支持使用身份验证和加密通讯协议进行安全通讯，确保数据的安全性和隐私性。</p><h2 id="添加插件" tabindex="-1">添加插件 <a class="header-anchor" href="#添加插件" aria-label="Permalink to “添加插件”">​</a></h2><p>在<strong>配置 -&gt; 北向应用</strong>，点击 <strong>添加应用</strong> 添加 MQTT 客户端节点。</p><h2 id="应用配置" tabindex="-1">应用配置 <a class="header-anchor" href="#应用配置" aria-label="Permalink to “应用配置”">​</a></h2><p>以下是使用 MQTT 插件配置节点时可用的参数：</p><table tabindex="0"><thead><tr><th>字段</th><th>说明</th></tr></thead><tbody><tr><td><strong>MQTT 版本</strong></td><td>MQTT 协议的版本，默认为 v3.1.1。</td></tr><tr><td><strong>客户端 ID</strong></td><td>MQTT 通信的客户端 id，必填。</td></tr><tr><td><strong>QoS 等级</strong></td><td>MQTT 通信的服务质量等级，可选，默认为 QoS 0 。</td></tr><tr><td><strong>上报数据格式</strong></td><td>上报数据的 JSON 格式：<br>· <strong>values-format</strong>：数据被分成 <code>values</code> 和 <code>errors</code> 的子对象。<br>· <strong>tags-format</strong>：数据被放在一个数组中。 <br>· <strong>ECP-format</strong>：在 <strong>tags-format</strong> 的基础上增加数据类型。<br>· <strong>Custom</strong>：自定义上报数据格式。<br>关于通信数据格式，见 <a href="./api.html#数据上报">数据上下行格式</a></td></tr><tr><td><strong>上报点位错误码</strong></td><td>点位采集报错时，上报点位错误码，默认开启。</td></tr><tr><td><strong>写请求主题</strong></td><td>接收点位写入请求的 MQTT 主题。关于通信数据格式，见 <a href="./api.html#写-tag">数据上下行格式</a>。如开启链路追踪，请按 W3C 标准配置用户属性 <code>traceparent</code> 和 <code>tracestate</code>。</td></tr><tr><td><strong>写响应主题</strong></td><td>发送点位写入响应的 MQTT 主题。</td></tr><tr><td><strong>驱动状态上报</strong></td><td>上报所有南向驱动状态到指定的 MQTT 主题。</td></tr><tr><td><strong>状态上报主题</strong></td><td>状态上报的主题。</td></tr><tr><td><strong>状态上报间隔</strong></td><td>上报南向节点状态的时间间隔，单位为秒，可填范围为 1-3600，默认1</td></tr><tr><td><strong>离线缓存</strong></td><td>离线缓存开关。连接断开时缓存 MQTT 消息，连接重建时同步缓存的消息到MQTT服务器。关于离线缓存功能的详细介绍，见<a href="#离线数据缓存">离线数据缓存</a></td></tr><tr><td><strong>缓存内存大小</strong></td><td>通信失败时内存消息缓存大小 (MB) 限制，必填；范围：[0, 1024]，不能大于缓存磁盘大小。</td></tr><tr><td><strong>缓存磁盘大小</strong></td><td>通信失败时磁盘消息缓存大小 (MB) 限制，必填，范围：[0, 10240]。<br>设为非零值时，缓存内存大小 也须为非零值。</td></tr><tr><td><strong>缓存消息重传间隔</strong></td><td>通信恢复、消息重传时每条消息之间的时间间隔 (MS)，必填；范围：[10, 120000]</td></tr><tr><td><strong>服务器地址</strong></td><td>MQTT Broker 地址，必填。</td></tr><tr><td><strong>服务器端口</strong></td><td>MQTT Broker 端口号，必填。</td></tr><tr><td><strong>用户名</strong></td><td>连接到 Broker 时使用的用户名，选填。</td></tr><tr><td><strong>密码</strong></td><td>连接到 Broker 时使用的密码，选填。</td></tr><tr><td><strong>SSL</strong></td><td>是否启用 SSL，选填，默认不启用。有关 SSL 的详细介绍，见 <a href="#mqtt-over-ssl">MQTT over SSL</a></td></tr><tr><td><strong>CA 证书</strong></td><td>CA 证书，启用 SSL 且使用自签发证书时必填。</td></tr><tr><td><strong>客户端证书</strong></td><td>客户端证书，使用 SSL 双向认证时必填。</td></tr><tr><td><strong>客户端私钥</strong></td><td>客户端密钥，使用 SSL 双向认证时必填。</td></tr></tbody></table><h3 id="离线数据缓存" tabindex="-1">离线数据缓存 <a class="header-anchor" href="#离线数据缓存" aria-label="Permalink to “离线数据缓存”">​</a></h3><p>离线数据缓存是 MQTT 插件特有的功能，当网络中断发生时，MQTT 插件首先将数据存储在内存缓存中，并且仅当内存缓存已满时才将数据刷新到磁盘缓存中。当网络恢复连接时，MQTT 插件将以 FIFO（先进先出）的顺序将缓存的数据发布到服务器上。这项功能在网络连接不稳定的场景中非常有用，可以帮助防止网络离线或暂时不可用时数据丢失，增强构建在 GridBeat 上的应用程序的鲁棒性和可靠性。</p><p>缓存容量取决于可用于消息排队的物理存储大小。离线数据缓存由<strong>离线缓存</strong>，<strong>缓存内存大小</strong>，和<strong>缓存磁盘大小</strong>参数控制，要开启离线数据缓存功能：</p><ol><li>将<strong>离线缓存</strong>参数设置为 <em>True</em> ，同时要配置<strong>缓存内存大小</strong>和<strong>缓存磁盘大小</strong>参数。</li><li>通过<strong>缓存内存大小</strong>参数指定内存缓存大小（单位为兆字节），最大允许缓存大小为 1GB 。</li><li>通过<strong>缓存磁盘大小</strong>参数指定磁盘缓存大小（单位为兆字节），最大允许缓存大小为 10GB 。</li><li>通过<strong>缓存消息重传间隔</strong>参数指定缓存消息重传间隔（单位为毫秒），最大允许缓存消息重传间隔为 120 秒 。</li></ol><p>下表给出了（使用<a href="./../../south-devices/modbus-tcp/modbus-tcp.html"> Modbus TCP 插件</a>时）离线缓存磁盘空间使用情况的一些统计数据。</p><ul><li>第一列是每条 MQTT 消息中数据点的数量</li><li>第二列是带有该数量数据点的 MQTT 消息负载大小（以字节为单位）</li><li>第三列是磁盘中缓存消息的数量</li><li>第四列是所需的磁盘空间大小（以千字节为单位）</li></ul><table tabindex="0"><thead><tr><th><em>每消息数据点数量</em></th><th><em>消息负载大小 (Bytes)</em></th><th><em>缓存消息数量</em></th><th><em>磁盘使用空间 (KB)</em></th></tr></thead><tbody><tr><td>10</td><td>219</td><td>100</td><td>64</td></tr><tr><td>10</td><td>219</td><td>1000</td><td>349</td></tr><tr><td>100</td><td>1284</td><td>100</td><td>228</td></tr><tr><td>100</td><td>1284</td><td>1000</td><td>2077</td></tr><tr><td>1000</td><td>12993</td><td>100</td><td>1401</td></tr><tr><td>1000</td><td>12993</td><td>1000</td><td>13427</td></tr></tbody></table><h3 id="驱动状态上报" tabindex="-1">驱动状态上报 <a class="header-anchor" href="#驱动状态上报" aria-label="Permalink to “驱动状态上报”">​</a></h3><p>驱动状态上报功能允许用户将南向驱动状态上报到指定的 MQTT 主题。如需上报驱动状态，请将<strong>驱动状态上报</strong>参数设置为 <code>True</code> ，并指定<strong>状态上报主题</strong>参数和<strong>状态上报间隔</strong>参数。上报数据格式如下：</p><div class="language-json"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">	&quot;timestamp&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1725583528917</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">	&quot;states&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">		&quot;node&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;modbus1&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">		&quot;link&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">		&quot;running&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	}, {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">		&quot;node&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;s7-1200&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">		&quot;link&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">		&quot;running&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	}, {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">		&quot;node&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;opcua1&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">		&quot;link&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">		&quot;running&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	}]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>其中：</p><ul><li><code>timestamp</code>：上报时间戳，单位为毫秒。</li><li><code>states</code>：驱动状态列表，每个元素包含以下字段： <ul><li><code>node</code>：南向驱动名称。</li><li><code>link</code>：驱动与设备之间的连接状态，0 表示断开连接状态，1 表示连接正常状态。</li><li><code>running</code>：驱动运行状态，3 表示运行状态、4 表示停止状态。</li></ul></li></ul><h3 id="mqtt-over-ssl" tabindex="-1">MQTT over SSL <a class="header-anchor" href="#mqtt-over-ssl" aria-label="Permalink to “MQTT over SSL”">​</a></h3><p>MQTT over SSL/TLS 是一种通过 SSL/TLS 加密传输 MQTT 消息的安全方法，用于在客户端和 MQTT 服务器之间传输数据，保证客户端和服务器之间传递的所有数据都是加密且安全的。</p><p>GridBeat 的 MQTT 插件支持 MQTT over SSL。 要启用 SSL 加密，请在配置节点时打开 <strong>SSL</strong> 参数：</p><ul><li>如果使用自签发的证书， 需要通过 <strong>CA 证书</strong>参数提供 CA 证书。</li><li>如果使用双向身份验证，还应通过<strong>客户端证书</strong>和<strong>客户端私钥</strong>参数分别提供客户端证书和私钥文件。</li></ul><h2 id="添加订阅" tabindex="-1">添加订阅 <a class="header-anchor" href="#添加订阅" aria-label="Permalink to “添加订阅”">​</a></h2><p>完成插件的添加和配置后，我们将继续通过订阅南向设备实现数据的转发。</p><p>完成设备配置后，在<strong>北向应用</strong>页，点击设备卡片/设备列进入<strong>组列表</strong>页。点击<strong>添加订阅</strong>，并进行如下设置：</p><ul><li><p><strong>南向设备</strong>：选择要订阅的南向设备，例如，modbus-tcp-1；</p></li><li><p><strong>组</strong>：选择南向设备下的某个组，例如，group-1。</p></li><li><p><strong>主题</strong>：指定上报主题，例如 /gridbeat/mqtt/upload。</p></li></ul><img src="`+n+'" style="border:thin solid #E0DCD9;width:60%;" alt="GridBeat version 2.4.0 MQTT subscribe interface"><p>上报数据的确切格式由<strong>上报数据格式</strong>参数控制，有 <strong>tags-format</strong> 和 <strong>values-format</strong> 两种格式。更多详细信息，请参阅 <a href="./api.html#data-upload">数据上下行格式</a>。</p><h2 id="测试-mqtt-插件" tabindex="-1">测试 MQTT 插件 <a class="header-anchor" href="#测试-mqtt-插件" aria-label="Permalink to “测试 MQTT 插件”">​</a></h2><p>本节将通过<a href="https://www.emqx.com/zh/mqtt/public-mqtt5-broker" target="_blank" rel="noreferrer">公共的 EMQX Broker（broker.emqx.io）</a>为例演示如何通过 MQTT 插件实现 Mobbus TCP 数据的转发。</p><h3 id="创建南向插件" tabindex="-1">创建南向插件 <a class="header-anchor" href="#创建南向插件" aria-label="Permalink to “创建南向插件”">​</a></h3><p>南向插件 Modbus TCP 已安装且完成组和点位的配置，和 GridBeat 之间通信正常。有关 Modbus TCP 插件的安装及配置，见 <a href="./../../south-devices/modbus-tcp/modbus-tcp.html">Modbus TCP</a>。</p><h3 id="创建北向插件" tabindex="-1">创建北向插件 <a class="header-anchor" href="#创建北向插件" aria-label="Permalink to “创建北向插件”">​</a></h3><p>在<strong>配置 -&gt; 北向应用</strong>，点击 <strong>添加应用</strong> 添加 MQTT 客户端节点。点击应用卡片上的<strong>应用配置</strong>按键进入应用配置界面设置 MQTT 连接，并进行如下设置：</p><ul><li>客户端 ID：注意每个 ID 要相互独立，不可以重复，这里使用默认值 mqtt；</li><li>消息服务质量：选择 0</li><li>服务器地址：使用默认的公共的 EMQX Broker（broker.emqx.io）；</li><li>服务器端口：使用 MQTT broker port（1883）；</li><li>其他保持默认配置，点击<strong>提交</strong>，完成北向应用的配置，应用卡片自动进入 <strong>运行中</strong> 的工作状态。</li></ul><p><img src="'+o+'" alt="mqtt-config"></p><h3 id="使用-mqttx-查看数据" tabindex="-1">使用 MQTTX 查看数据 <a class="header-anchor" href="#使用-mqttx-查看数据" aria-label="Permalink to “使用 MQTTX 查看数据”">​</a></h3><p>订阅完成后，用户可以使用 MQTT 客户端（推荐使用 MQTTX，可在<a href="https://www.emqx.com/zh/products/mqttx" target="_blank" rel="noreferrer">官网</a>中下载）连接到公共的 EMQX 代理来查看上报的数据：</p><p><strong>建立连接</strong></p><p>在 MQTTX 中，点击<strong>新建连接</strong>并进行如下配置：</p><ul><li><strong>名称</strong>：输入连接名称，如 gridbeatmqtt</li><li><strong>服务器地址</strong>：保留默认 broker.emqx.io</li><li><strong>端口</strong>：保留默认值 1883</li><li>其他可保留默认设置</li><li>点击<strong>连接</strong></li></ul><p><strong>添加订阅</strong></p><p>在连接窗口，点击<strong>添加订阅</strong>，在弹出的窗口中进行如下设置：</p><ul><li><p><strong>Topic</strong>：与设置北向应用参数中的主题保持一致，例如 <code>/gridbeat/mqtt/upload</code>。</p><div class="tip custom-block"><p class="custom-block-title custom-block-title-default">TIP</p><p>默认的上传 Topic 的主题格式为 <code>/gridbeat/{node_name}/upload</code>，其中 {node_name} 为创建的北向应用的名称。用户也可自定义上报主题。</p></div></li><li><p><strong>QoS</strong>：保留默认值 0</p></li><li><p>其他可保留默认设置</p></li></ul><p>此时，我们将能在 MQTTX 中看到由 GridBeat 转发的数据，如下图所示。</p><p><img src="'+e+'" alt="mqttx"></p><h2 id="运行与维护" tabindex="-1">运行与维护 <a class="header-anchor" href="#运行与维护" aria-label="Permalink to “运行与维护”">​</a></h2><p>在设备卡片或设备列，您可点击数据统计图表查看及应用运行情况、接受和发送的数据情况。关于统计字段的说明，见<a href="./../north-apps.html">创建北向应用</a>。</p><p>如果设备运行出现任何问题，您可点击 DEBUG 日志图表，此时系统将自动打印该节点的 DEBUG 级别日志，十分钟后将切回系统默认级别日志。稍后，您可点击页面顶部功能栏的<strong>系统信息</strong> -&gt; <strong>日志</strong>查看日志，并进行故障诊断。稍后，您可点击页面顶部功能栏的<strong>系统信息</strong> -&gt; <strong>日志</strong>查看日志，并进行故障诊断。有关系统日志的详细解析，见<a href="./../../../admin/log-management.html">管理日志</a>。</p>',53)])])}const m=s(l,[["render",d]]);export{E as __pageData,m as default};
